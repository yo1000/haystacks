<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head th:replace="_fragments :: head (title='Table ' + ${tableName})">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Table name | haystacks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/haystacks.css" th:href="@{/css/haystacks.css}">
  <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</head>
<body>
<div th:replace="_fragments :: navbar"></div>
<section class="section">
  <div class="container">
    <h1 id="tableName" class="title is-2"></h1>
    <p class="subtitle">
      <span id="tableComment"></span>
      <small><span id="tableNote"></span></small>
    </p>
  </div>
</section>
<section class="section">
  <div class="container">
    <h2 class="title is-4">Columns</h2>
    <div id="columns"></div>
  </div>
</section>
<section class="section">
  <div class="container">
    <h2 class="title is-4">Indexes</h2>
    <div id="indexes"></div>
  </div>
</section>
<section class="section">
  <div class="container">
    <h2 class="title is-4">Statement</h2>
    <div id="statement"></div>
  </div>
</section>
<script th:inline="javascript">
(function () {
    Node.prototype.appendChildElm = function(name, func) {
        const node = this.appendChild(document.createElement(name))
        if (func) func(node)
        return node
    }

    Node.prototype.appendChildTxt = function(text) {
        return this.appendChild(document.createTextNode(text))
    }

    Node.prototype.removeChildren = function() {
        while (this.firstChild) {
            this.removeChild(this.firstChild);
        }
    }

    Node.prototype.appendChildNote = function(note) {
        this.removeChildren()

        this.appendChildElm("span", (spanElm) => {
            spanElm.appendChildTxt(note)
        })
        this.appendChildElm("a", (aElm) => {
            aElm.appendChildElm("i", (iElm) => {
                iElm.classList.add("fas")
                iElm.classList.add("fa-pencil-alt")
            })
            aElm.addEventListener("click", (event) => {
                const clickEditContainerElm = event.target.closest(".is-data-note-container")
                const inputValue = clickEditContainerElm.querySelector("span").innerText

                clickEditContainerElm.removeChildren()

                clickEditContainerElm.appendChildElm("input", (inputElm) => {
                    inputElm.setAttribute("type", "text")
                    inputElm.classList.add("input")
                    inputElm.value = inputValue
                })
                clickEditContainerElm.appendChildElm("a", (aElm) => {
                    const onClickSave = (event) => {
                        const clickSaveContainerElm = event.target.closest(".is-data-note-container")
                        const savingInputElm = clickSaveContainerElm.querySelector("input")
                        savingInputElm.setAttribute("readonly", "readonly")

                        const savingFqn = clickSaveContainerElm.dataset.fqn
                        const savingInputValue = savingInputElm.value

                        clickSaveContainerElm.removeChildren()

                        clickSaveContainerElm.appendChild(savingInputElm)
                        clickSaveContainerElm.appendChildElm("i", (iElm) => {
                            iElm.classList.add("fas")
                            iElm.classList.add("fa-circle-notch")
                            iElm.classList.add("fa-spin")
                        })

                        fetch("/api/notes/" + savingFqn, {
                            method: "POST",
                            body: savingInputValue
                        }).then(resp => {
                            if (!resp.ok) throw Error(resp.statusText)
                            return resp
                        }).then(() => {
                            clickSaveContainerElm.appendChildNote(savingInputValue)
                        }).catch(() => {
                            const failedInputElm = clickSaveContainerElm.querySelector("input")
                            failedInputElm.removeAttribute("readonly")

                            clickSaveContainerElm.removeChildren()

                            clickSaveContainerElm.appendChild(failedInputElm)
                            clickSaveContainerElm.appendChildElm("a", (aElm) => {
                                aElm.appendChildElm("i", (iElm) => {
                                    iElm.setAttribute("title", "Has not been saved yet")
                                    iElm.classList.add("fas")
                                    iElm.classList.add("fa-exclamation-triangle")
                                })
                                aElm.addEventListener("click", (event) => onClickSave(event))
                            })
                        })
                    }

                    aElm.appendChildElm("i", (iElm) => {
                        iElm.classList.add("fas")
                        iElm.classList.add("fa-save")
                    })
                    aElm.addEventListener("click", (event) => onClickSave(event))
                })
            })
        })
    }

    const tableName = /*[[${tableName}]]*/ "tableName";
    fetch("/api/tables/" + tableName).then(resp => {
        if (!resp.ok) throw Error(resp.statusText)
        return resp.json()
    }).then((table) => {
        document.querySelector("#tableName").appendChildTxt(table.name)

        if (table.comment) {
            document.querySelector("#tableComment").appendChildTxt(table.comment)
        }

        const tableNoteContainerElm = document.querySelector("#tableNote")
        tableNoteContainerElm.setAttribute("data-fqn", table.fqn)
        tableNoteContainerElm.classList.add("is-data-note-container")
        tableNoteContainerElm.appendChildNote(table.note)

        document.querySelector("#columns").appendChildElm("table", (tableElm) => {
            tableElm.classList.add("table")
            tableElm.classList.add("is-narrow")
            tableElm.classList.add("is-hoverable")
            tableElm.classList.add("is-fullwidth")

            tableElm.appendChildElm("thead", (theadElm) => {
                theadElm.appendChildElm("tr", (trElm) => {
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Name") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Type") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Nullable") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Default") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Parent") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Children") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Comment") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Note") })
                })
            })

            tableElm.appendChildElm("tbody", (tbodyElm) => {
                table.columns.forEach(column => {
                    tbodyElm.appendChildElm("tr", (trElm) => {
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildElm("span", (fkSpanElm) => {
                                fkSpanElm.classList.add("is-column-name")
                                fkSpanElm.appendChildElm("span", (pkSpanElm) => {
                                    pkSpanElm.classList.add("is-column-name")
                                    pkSpanElm.appendChildTxt(column.name)

                                    if (table.indexes.find((element) => {
                                        return element.type === "PRIMARY" && element.columns.find((col) => {
                                            return col.column === column.name
                                        })
                                    })) {
                                        pkSpanElm.classList.add("is-primary-key-column")
                                    }

                                    if (column.parent) {
                                        fkSpanElm.classList.add("is-foreign-key-column")
                                    }
                                })
                            })
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildTxt(column.type)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            if (column.nullable) {
                                tdElm.appendChildElm("i", (iElm) => {
                                    iElm.classList.add("fas")
                                    iElm.classList.add("fa-check")
                                })
                            }
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildTxt(column.default)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            if (column.parent) {
                                tdElm.appendChildElm("a", (aElm) => {
                                    aElm.setAttribute("href", column.parent.table)
                                    aElm.appendChildTxt(`${column.parent.table}.${column.parent.column}`)
                                })
                            }
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            if (column.children && column.children.length) {
                                tdElm.appendChildElm("ul", (ulElm) => {
                                    column.children.forEach(child => {
                                        ulElm.appendChildElm("li", (liElm) => {
                                            liElm.appendChildElm("a", (aElm) => {
                                                aElm.setAttribute("href", child.table)
                                                aElm.appendChildTxt(`${child.table}.${child.column}`)
                                            })
                                        })
                                    })
                                })
                            }
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildTxt(column.comment)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.setAttribute("data-fqn", column.fqn)
                            tdElm.classList.add("is-data-note-container")

                            tdElm.appendChildNote(column.note)
                        })
                    })
                })
            })
        })

        document.querySelector("#indexes").appendChildElm("table", (tableElm) => {
            tableElm.classList.add("table")
            tableElm.classList.add("is-narrow")
            tableElm.classList.add("is-hoverable")
            tableElm.classList.add("is-fullwidth")

            tableElm.appendChildElm("thead", (theadElm) => {
                theadElm.appendChildElm("tr", (trElm) => {
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Name") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Type") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Columns") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Comment") })
                    trElm.appendChildElm("th", (thElm) => { thElm.appendChildTxt("Note") })
                })
            })

            tableElm.appendChildElm("tbody", (tbodyElm) => {
                table.indexes.forEach(index => {
                    tbodyElm.appendChildElm("tr", (trElm) => {
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildElm("i", (iElm) => {
                                if (index.type === "PRIMARY") {
                                    iElm.classList.add("fas")
                                    iElm.classList.add("fa-circle")
                                } else if (index.type === "UNIQUE") {
                                    iElm.classList.add("far")
                                    iElm.classList.add("fa-dot-circle")
                                } else if (index.type === "PERFORMANCE") {
                                    iElm.classList.add("far")
                                    iElm.classList.add("fa-circle")
                                }
                            })
                            tdElm.appendChildTxt(` ${index.name}`)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildTxt(index.type)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            if (index.columns && index.columns.length) {
                                tdElm.appendChildElm("ul", (ulElm) => {
                                    index.columns.forEach(column => {
                                        ulElm.appendChildElm("li", (liElm) => {
                                            liElm.appendChildTxt(column.column)
                                        })
                                    })
                                })
                            }
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.appendChildTxt(index.comment)
                        })
                        trElm.appendChildElm("td", (tdElm) => {
                            tdElm.setAttribute("data-fqn", index.fqn)
                            tdElm.classList.add("is-data-note-container")

                            tdElm.appendChildNote(index.note)
                        })
                    })
                })
            })
        })

        document.querySelector("#statement").appendChildElm("pre", (preElm) => {
            preElm.appendChildElm("code", (codeElm) => {
                codeElm.appendChildTxt(table.statement)
                codeElm.classList.add("sql")
            })
            hljs.initHighlightingOnLoad()
        })
    }).catch((err) => {
        console.error(err)
    })
})()
</script>
</body>
</html>